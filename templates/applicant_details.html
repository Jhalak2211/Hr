<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Applicant Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="container mt-5 mb-5">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Applicant: <strong>{{ applicant['applicant_name'] }}</strong></h2>
        <div>
            <button class="btn btn-primary mr-2" data-toggle="modal" data-target="#generateTestModal">
                üß† Generate Test & Send Link
            </button>
            <button class="btn btn-success" data-toggle="modal" data-target="#thresholdModal">
                üìà Set Shortlist Threshold
            </button>
        </div>
    </div>

    <p><a href="/job/{{ applicant['job_id'] }}/applicants">&larr; Back to Applicant List</a></p>
    <hr>

    <!-- MAIN LAYOUT -->
    <div class="row">
        <!-- LEFT: Photo -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">Live Photo Capture</div>
                <div class="card-body text-center">
                    {% if applicant['live_photo_filename'] %}
                        <img src="{{ url_for('uploaded_file', filename=applicant['live_photo_filename']) }}"
                             class="img-fluid rounded" style="max-height: 300px;" alt="Live Photo">
                    {% else %}
                        <p class="text-muted">No live photo was captured or saved.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- RIGHT: Scores & Docs -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">Job Match Analysis</div>
                <div class="card-body">
                    <h4>Match Score:
                        <span class="badge badge-success">{{ applicant['match_score'] }}%</span>
                    </h4>
                    <hr>
                    <p><strong>‚úÖ Matched Skills:</strong></p>
                    <p>{{ applicant['matched_skills'] or 'No matches found' }}</p>
                    <hr>
                    <p><strong>‚ùå Missing Skills:</strong></p>
                    <p>{{ applicant['missing_skills'] or 'No missing skills detected' }}</p>
                    <hr>

                    <!-- AI EXPLANATION COLLAPSIBLE -->
                    {% if applicant['ai_feedback'] %}
                    <button class="btn btn-outline-primary btn-sm" type="button" data-toggle="collapse" data-target="#aiExplanation">
                        üí¨ Show AI Explanation (Why this score?)
                    </button>
                    <div class="collapse mt-3" id="aiExplanation">
                        <div class="card card-body" style="background: #f8f9fa;">
                            <pre style="white-space: pre-wrap; font-size: 0.95rem;">{{ applicant['ai_feedback'] }}</pre>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted"><em>No AI feedback available for this application.</em></p>
                    {% endif %}
                </div>
            </div>

            <!-- DOCUMENTS -->
            <div class="card">
                <div class="card-header">Documents</div>
                <div class="card-body">
                    <a href="{{ url_for('uploaded_file', filename=applicant['resume_filename']) }}"
                       target="_blank" class="btn btn-primary btn-block">View Resume</a>

                    {% if applicant['photo_filename'] %}
                        <a href="{{ url_for('uploaded_file', filename=applicant['photo_filename']) }}"
                           target="_blank" class="btn btn-secondary btn-block mt-2">View Uploaded Photo</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Threshold Modal -->
<div class="modal fade" id="thresholdModal" tabindex="-1" role="dialog" aria-labelledby="thresholdModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="thresholdForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="thresholdModalLabel">Set Shortlist Threshold</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <label for="thresholdInput">Enter threshold score (0‚Äì100):</label>
        <input type="number" id="thresholdInput" class="form-control" min="0" max="100" required>
        <small class="text-muted">Candidates with score ‚â• threshold will receive a ‚ÄúShortlisted‚Äù email.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Send Emails</button>
      </div>
    </form>
  </div>
</div>

<!-- Test Generation Modal -->
<div class="modal fade" id="generateTestModal" tabindex="-1" role="dialog" aria-labelledby="generateTestModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="generateTestForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="generateTestModalLabel">üß† Generate Candidate Test</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <label>Number of Questions</label>
        <div class="form-group mt-2">
            <label>Logical Reasoning:</label>
            <input type="number" class="form-control" id="logicalQs" value="2" min="0">
        </div>
        <div class="form-group">
            <label>Cognitive Ability:</label>
            <input type="number" class="form-control" id="cognitiveQs" value="2" min="0">
        </div>
        <div class="form-group">
            <label>Scenario-Based:</label>
            <input type="number" class="form-control" id="scenarioQs" value="2" min="0">
        </div>
        <div class="form-group">
            <label>Technical Questions:</label>
            <input type="number" class="form-control" id="technicalQs" value="3" min="0">
        </div>
        <div class="form-group">
            <label>Technical Topics:</label>
            <input type="text" class="form-control" id="techTopics" placeholder="e.g., Python, Flask, SQL">
        </div>
        <div class="form-group">
            <label>Total Test Duration (minutes):</label>
            <input type="number" class="form-control" id="testDuration" value="30" min="5">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Generate & Send</button>
      </div>
    </form>
  </div>
</div>

<!-- Threshold Script -->
<script>
$('#thresholdForm').on('submit', async function(event) {
    event.preventDefault();
    const threshold = $('#thresholdInput').val();
    const jobId = JSON.parse('{{ applicant["job_id"] | tojson | safe }}');
    const response = await fetch(`/shortlist_above_threshold/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ threshold: threshold })
    });
    const result = await response.json();
    alert(result.message);
    $('#thresholdModal').modal('hide');
});
</script>

<!-- Test Generation Script -->
<script>
$('#generateTestForm').on('submit', async function(event) {
    event.preventDefault();
    const jobId = JSON.parse('{{ applicant["job_id"] | tojson | safe }}');
    const payload = {
        logical: $('#logicalQs').val(),
        cognitive: $('#cognitiveQs').val(),
        scenario: $('#scenarioQs').val(),
        technical: $('#technicalQs').val(),
        topics: $('#techTopics').val(),
        duration: $('#testDuration').val()
    };

    const response = await fetch(`/tests/create/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const result = await response.json();
    alert(result.message);
    $('#generateTestModal').modal('hide');
});
</script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
